# TODO: UserAgentChanger Extension - Refactoring to AUTO Mode
# Project: Simplify extension with AUTO mode and smart per-tab system

project_info:
  name: UserAgentChanger Extension - AUTO Mode Implementation
  version: 2.0.0
  description: Refactor to use AUTO mode with smart per-tab system, removing Other Settings
  created: 2025-12-26
  status: in-progress
  author: trystan4861
  next_task_to_start: 23
  last_updated: 2025-12-27

notes: |
  CAMBIO IMPORTANTE: Refactorización del sistema de User-Agents
  
  NUEVO SISTEMA:
  - Eliminar sección "Other Settings" (permanentOverride y perTabSpoof)
  - Crear User-Agent especial "AUTO" (badge: "AUTO", palabra reservada)
  - Sistema per-tab automático e inteligente:
    * Si hay 1 pestaña: La selección se aplica a esa pestaña y a todas las nuevas
    * Si hay >1 pestaña: La selección se aplica SOLO a la pestaña activa
  
  LÓGICA DE USER-AGENTS:
  1. AUTO:
     - Aplica spoofs permanentes por URL
     - Si no hay spoof para la URL, usa el default del navegador (fallback)
     - Badge: "AUTO"
     - NO sobreescribe pestañas que ya tienen AUTO
  
  2. DEFAULT:
     - Usa el User-Agent real del navegador
     - NO sobreescribe pestañas que ya tienen AUTO
     - Sin badge
  
  3. Otros UAs (iPhone, Android, etc):
     - Se aplican SOLO a la pestaña activa
     - Usan el User-Agent específico configurado
     - Badge: su alias correspondiente
  
  PRIORIDADES:
  - AUTO tiene prioridad máxima cuando hay spoof para la URL
  - Las selecciones manuales (iPhone, Android) solo afectan a su pestaña
  - DEFAULT no interfiere con AUTO
  
  PALABRAS RESERVADAS:
  - "AUTO" no puede ser usado como alias al crear nuevos user-agents
  
  MANTENER:
  - Sistema de navegación con menú lateral ✓
  - Permanent Spoof List ✓
  - Import/Export Settings ✓
  - About section ✓
  - Internacionalización ✓

tasks:
  # ============================================================================
  # TAREAS COMPLETADAS ANTERIORMENTE
  # ============================================================================
  
  - id: 1
    name: Crear sistema de navegación con menú lateral
    status: completed
    completed_date: 2025-12-26
    
  - id: 2
    name: Implementar sistema de gestión de secciones/vistas
    status: completed
    completed_date: 2025-12-26
    
  - id: 3
    name: Crear interfaz de Permanent Spoof List
    status: completed
    completed_date: 2025-12-26
    
  - id: 4
    name: Implementar almacenamiento de Permanent Spoofs
    status: completed
    completed_date: 2025-12-26
    
  - id: 5
    name: Implementar lógica en background.js para Permanent Spoofs
    status: completed
    completed_date: 2025-12-26
    
  - id: 6
    name: Crear interfaz de Import/Export Settings
    status: completed
    completed_date: 2025-12-27
    
  - id: 7
    name: Implementar funcionalidad de Export
    status: completed
    completed_date: 2025-12-27
    
  - id: 8
    name: Implementar funcionalidad de Import
    status: completed
    completed_date: 2025-12-27
    
  - id: 9
    name: Crear interfaz de Other Settings
    status: completed
    completed_date: 2025-12-27
    note: "SERÁ ELIMINADA en la refactorización"
    
  - id: 10
    name: Implementar lógica de Other Settings
    status: completed
    completed_date: 2025-12-27
    note: "SERÁ ELIMINADA en la refactorización"
    
  - id: 11.1
    name: Agregar badge de versión en sección About
    status: completed
    completed_date: 2025-12-27

  # ============================================================================
  # FASE REFACTORIZACIÓN: SISTEMA AUTO
  # ============================================================================
  
  - id: 23
    name: Eliminar sección Other Settings de la UI
    description: |
      Eliminar completamente la sección "Other Settings" de la interfaz:
      
      Cambios en options.html:
      - Eliminar item del menú "Other Settings"
      - Eliminar sección completa #otherSettingsSection
      
      Cambios en options.css:
      - Eliminar estilos específicos de Other Settings si los hay
      
      Cambios en options.js:
      - Eliminar función setupOtherSettings()
      - Eliminar event listeners relacionados
      - Eliminar referencias a permanentOverride y perTabSpoof en la UI
      
      IMPORTANTE:
      - NO eliminar la lógica de permanent spoofs de background.js
      - Mantener el storage de permanentSpoofs
      - Solo eliminar la UI y configuraciones de override/per-tab
      
      Archivos a modificar:
      - options.html
      - options.css (si aplica)
      - options.js
    priority: high
    estimated_hours: 1
    dependencies: []
    status: completed
    completed_date: 2025-12-27
    
  - id: 24
    name: Crear User-Agent especial "AUTO"
    description: |
      Agregar el User-Agent especial "AUTO" a los defaults:
      
      Características de AUTO:
      - id: 'auto'
      - name: i18n.getMessage('autoUserAgent') // "Definido en Spoof List"
      - alias: 'AUTO'
      - userAgent: '' (vacío, se determina dinámicamente)
      - mode: 'auto' (nuevo modo especial)
      - badgeTextColor: '#ffffff'
      - badgeBgColor: '#10b981' (verde para diferenciarlo)
      
      Agregar al array getDefaultUserAgents() en popup.js:
      - Colocar AUTO como segunda opción (después de default)
      
      Validación en options.js:
      - Al crear/editar user-agents, validar que alias !== 'AUTO'
      - Mostrar error si intenta usar 'AUTO' como alias
      - Agregar mensaje de error en traducciones
      
      Traducciones a agregar:
      - autoUserAgent: "Defined in Spoof List" (EN) / "Definido en Spoof List" (ES)
      - autoUserAgentDesc: "Uses permanent spoofs based on URL" (EN) / "Usa spoofs permanentes según URL" (ES)
      - aliasReservedError: "'AUTO' is a reserved word" (EN) / "'AUTO' es una palabra reservada" (ES)
      
      Archivos a modificar:
      - popup.js: Agregar AUTO a getDefaultUserAgents()
      - options.js: Agregar validación de alias
      - _locales/en/messages.json
      - _locales/es/messages.json
    priority: high
    estimated_hours: 2
    dependencies: [23]
    status: pending
    
  - id: 25
    name: Implementar sistema per-tab automático inteligente
    description: |
      Crear sistema que detecta número de pestañas y aplica lógica correspondiente:
      
      Lógica en background.js:
      
      1. Crear función getTabCount():
         - Retorna el número de pestañas abiertas
         - Filtra pestañas de chrome:// y extensiones
      
      2. Modificar setUserAgent() para soportar modo AUTO:
         - Si userAgent.mode === 'auto':
           * Obtener URL de la pestaña
           * Buscar spoof permanente para esa URL
           * Si existe spoof: aplicar ese User-Agent
           * Si no existe spoof: no crear regla (usar default del navegador)
         - Aplicar regla solo a la pestaña específica (siempre per-tab)
      
      3. Sistema de almacenamiento per-tab:
         - Crear en storage: tabUserAgents = { [tabId]: userAgentId }
         - Al seleccionar UA: guardar en tabUserAgents[tabId]
         - Al cambiar de pestaña: actualizar badge según tabUserAgents[tabId]
         - Al cerrar pestaña: limpiar tabUserAgents[tabId]
      
      4. Lógica de aplicación según número de pestañas:
         - Si 1 pestaña: guardar activeId globalmente + en tabUserAgents
         - Si >1 pestaña: solo guardar en tabUserAgents (no cambiar activeId)
      
      5. Inicialización de nuevas pestañas:
         - chrome.tabs.onCreated: si hay activeId global, aplicarlo a nueva pestaña
         - Si activeId es 'auto': aplicar regla AUTO
         - Si activeId es otro: aplicar ese UA
      
      Funciones a crear:
      - getTabCount(): Cuenta pestañas válidas
      - setUserAgentForTab(tabId, userAgentId): Aplica UA a pestaña específica
      - getActiveUserAgentForTab(tabId): Obtiene UA activo de una pestaña
      - cleanupClosedTabs(): Limpia storage de pestañas cerradas
      - applyAutoRuleForTab(tabId, url): Aplica regla AUTO a una pestaña
      
      Archivos a modificar:
      - background.js: Nueva lógica completa per-tab
    priority: high
    estimated_hours: 6
    dependencies: [24]
    status: pending
    
  - id: 26
    name: Actualizar badge para mostrar estado AUTO
    description: |
      Modificar updateBadgeForTab() para soportar modo AUTO:
      
      Lógica del badge:
      - Si tabUserAgents[tabId] === 'auto':
        * Obtener URL de la pestaña
        * Buscar spoof permanente para esa URL
        * Si hay spoof: mostrar badge 'AUTO' (color verde #10b981)
        * Si no hay spoof: no mostrar badge (es default)
      
      - Si tabUserAgents[tabId] === 'default':
        * No mostrar badge
      
      - Si tabUserAgents[tabId] === otro UA:
        * Mostrar badge del UA correspondiente
      
      Título del badge (tooltip):
      - AUTO con spoof: "User-Agent Changer\nAUTO: [Nombre del UA del spoof]"
      - AUTO sin spoof: "User-Agent Changer\nAUTO: Default"
      - DEFAULT: "User-Agent Changer\nDefault"
      - Otro UA: "User-Agent Changer\n[Nombre del UA]"
      
      Archivos a modificar:
      - background.js: updateBadgeForTab()
    priority: high
    estimated_hours: 2
    dependencies: [25]
    status: pending
    
  - id: 27
    name: Actualizar popup.js para sistema per-tab
    description: |
      Modificar popup.js para trabajar con el nuevo sistema:
      
      Cambios en loadUserAgents():
      - Obtener pestaña activa actual
      - Leer tabUserAgents[currentTabId] en lugar de activeId global
      - Si no existe entrada para esta pestaña, mostrar activeId global
      - Marcar como activo el UA correspondiente
      
      Cambios en activateUserAgent():
      - Obtener pestaña activa actual
      - Obtener número total de pestañas (getTabCount)
      - Si 1 pestaña:
        * Guardar en activeId global
        * Guardar en tabUserAgents[tabId]
        * Aplicar a todas las pestañas futuras
      - Si >1 pestaña:
        * Solo guardar en tabUserAgents[tabId]
        * NO cambiar activeId global
      - Enviar mensaje a background con tabId
      
      Mostrar indicador visual:
      - Si modo AUTO está activo: mostrar texto explicativo
      - Si hay 1 pestaña: indicar "aplicado globalmente"
      - Si hay >1 pestaña: indicar "solo esta pestaña"
      
      Archivos a modificar:
      - popup.js
    priority: high
    estimated_hours: 3
    dependencies: [25]
    status: pending
    
  - id: 28
    name: Limpiar código de permanentOverride y perTabSpoof
    description: |
      Eliminar toda referencia a las configuraciones obsoletas:
      
      En background.js:
      - Eliminar referencias a permanentOverride
      - Eliminar referencias a perTabSpoof
      - Eliminar listeners de storage para estos settings
      - Simplificar lógica de prioridades (AUTO siempre usa spoofs cuando aplica)
      - Eliminar código de session rules vs dynamic rules (ahora todo es session)
      
      En options.js:
      - Eliminar funciones savePermanentOverrideSetting()
      - Eliminar funciones savePerTabSpoofSetting()
      - Eliminar referencias en export/import
      
      En storage:
      - NO eliminar permanentSpoofs (se sigue usando)
      - NO limpiar storage del usuario (migración suave)
      - Los valores viejos simplemente se ignoran
      
      Archivos a modificar:
      - background.js
      - options.js
    priority: medium
    estimated_hours: 2
    dependencies: [25, 26, 27]
    status: pending
    
  - id: 29
    name: Actualizar traducciones para sistema AUTO
    description: |
      Agregar y actualizar traducciones necesarias:
      
      Nuevas claves en _locales/*/messages.json:
      - autoUserAgent: Nombre del UA AUTO
      - autoUserAgentDesc: Descripción del modo AUTO
      - autoUserAgentPreview: Texto preview en popup
      - aliasReservedError: Error al usar AUTO como alias
      - appliedToCurrentTab: "Applied to current tab only"
      - appliedGlobally: "Applied to all tabs"
      - autoModeActive: "AUTO mode active"
      - autoModeUsingSspoof: "Using spoof for this URL"
      - autoModeUsingDefault: "No spoof for this URL (using default)"
      
      Eliminar claves obsoletas:
      - permanentOverride (y sus descripciones)
      - perTabSpoof (y sus descripciones)
      - Mantener las de permanent spoofs (esas sí se usan)
      
      Archivos a modificar:
      - _locales/en/messages.json
      - _locales/es/messages.json
    priority: medium
    estimated_hours: 1
    dependencies: [24, 27]
    status: pending
    
  - id: 30
    name: Testing completo del sistema AUTO
    description: |
      Realizar pruebas exhaustivas del nuevo sistema:
      
      Escenarios a probar:
      
      1. Con 1 pestaña:
         -
